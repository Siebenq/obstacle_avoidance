================================================================================
                    ICPæ ‡å®šèŠ‚ç‚¹ - å¿«é€Ÿä½¿ç”¨é€ŸæŸ¥è¡¨
================================================================================

ğŸ“¦ åŠŸèƒ½
------
âœ… è®¢é˜…ä¸¤ä¸ªç‚¹äº‘è¯é¢˜ (topic1 å’Œ topic2)
âœ… ä½¿ç”¨PCLçš„ICPç®—æ³•æ ‡å®šå¤–å‚
âœ… ä»¥Eigen::Matrix4fæ ¼å¼å‘å¸ƒå˜æ¢çŸ©é˜µ

================================================================================
ğŸš€ å¿«é€Ÿå‘½ä»¤
================================================================================

# 1. ç¼–è¯‘
cd /home/zjq/thesis
colcon build --packages-select obstacle_avoidance
source install/setup.bash

# 2. å¯åŠ¨èŠ‚ç‚¹
ros2 launch obstacle_avoidance icp_calibration.launch.py

# 3. æŸ¥çœ‹ç»“æœ
ros2 topic echo /icp_transform

# 4. æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
ros2 node info /icp_calibration_node

# 5. æŸ¥çœ‹æ¶ˆæ¯å®šä¹‰
ros2 interface show obstacle_avoidance/msg/TransformMatrix

# 6. ä½¿ç”¨Pythonç›‘å¬è„šæœ¬ï¼ˆç¾åŒ–è¾“å‡ºï¼‰
python3 src/obstacle_avoidance/scripts/icp_transform_listener.py

================================================================================
âš™ï¸ é…ç½®æ–‡ä»¶ä½ç½®
================================================================================

é…ç½®æ–‡ä»¶: src/obstacle_avoidance/config/icp_calibration_params.yaml

å¿…é¡»ä¿®æ”¹çš„å‚æ•°:
  topic1: "/camera1/points"        â† æ”¹ä¸ºä½ çš„ç¬¬ä¸€ä¸ªç‚¹äº‘è¯é¢˜
  topic2: "/camera2/points"        â† æ”¹ä¸ºä½ çš„ç¬¬äºŒä¸ªç‚¹äº‘è¯é¢˜

å¸¸ç”¨è°ƒæ•´:
  auto_calibrate: true             â† æ˜¯å¦è‡ªåŠ¨æ ‡å®š
  calibration_interval: 5.0        â† æ ‡å®šé—´éš”ï¼ˆç§’ï¼‰
  max_correspondence_distance: 0.5 â† ICPåŒ¹é…è·ç¦»

================================================================================
ğŸ“Š è¾“å‡ºæ¶ˆæ¯æ ¼å¼
================================================================================

TransformMatrix æ¶ˆæ¯åŒ…å«:
  - matrix[16]        : 4x4å˜æ¢çŸ©é˜µï¼ˆè¡Œä¼˜å…ˆï¼‰
  - fitness_score     : é€‚é…åº¦åˆ†æ•°ï¼ˆè¶Šå°è¶Šå¥½ï¼‰
  - converged         : æ˜¯å¦æ”¶æ•›
  - rmse              : å‡æ–¹æ ¹è¯¯å·®ï¼ˆç±³ï¼‰
  - source_frame_id   : æºåæ ‡ç³»
  - target_frame_id   : ç›®æ ‡åæ ‡ç³»
  - source_points     : æºç‚¹äº‘ç‚¹æ•°
  - target_points     : ç›®æ ‡ç‚¹äº‘ç‚¹æ•°

è´¨é‡è¯„ä¼°æ ‡å‡†:
  fitness_score < 0.001  â†’ ä¼˜ç§€ â­â­â­â­â­
  fitness_score < 0.01   â†’ è‰¯å¥½ â­â­â­â­
  fitness_score < 0.1    â†’ å¯æ¥å— â­â­â­
  fitness_score > 0.1    â†’ éœ€è¦è°ƒæ•´å‚æ•° â­

================================================================================
ğŸ”§ å¸¸ç”¨å‚æ•°è°ƒæ•´
================================================================================

æé«˜ç²¾åº¦:
  max_iterations: 100              # å¢åŠ è¿­ä»£æ¬¡æ•°
  voxel_leaf_size: 0.02           # å‡å°ä½“ç´ ï¼Œä¿ç•™ç»†èŠ‚

åŠ å¿«é€Ÿåº¦:
  max_iterations: 30              # å‡å°‘è¿­ä»£
  voxel_leaf_size: 0.1            # å¢å¤§ä½“ç´ ï¼Œé™é‡‡æ ·

ç‚¹äº‘é‡å åº¦ä½:
  max_correspondence_distance: 1.0  # å¢å¤§åŒ¹é…è·ç¦»

ç‚¹äº‘é‡å åº¦é«˜:
  max_correspondence_distance: 0.2  # å‡å°åŒ¹é…è·ç¦»

================================================================================
ğŸ’» ä»£ç ä½¿ç”¨ç¤ºä¾‹
================================================================================

Pythonè§£æçŸ©é˜µ:
---------------
import numpy as np

matrix = np.array(msg.matrix).reshape(4, 4)
rotation = matrix[:3, :3]
translation = matrix[:3, 3]

print(f"å¹³ç§»: {translation}")
print(f"æ—‹è½¬:\n{rotation}")

C++è§£æçŸ©é˜µ:
------------
#include <Eigen/Dense>

Eigen::Matrix4f matrix;
for (int i = 0; i < 4; ++i) {
    for (int j = 0; j < 4; ++j) {
        matrix(i, j) = msg.matrix[i * 4 + j];
    }
}

// ä½¿ç”¨çŸ©é˜µå˜æ¢ç‚¹äº‘
pcl::transformPointCloud(*input, *output, matrix);

================================================================================
ğŸ› æ•…éšœæ’æŸ¥
================================================================================

é—®é¢˜1: "ç­‰å¾…ç‚¹äº‘æ•°æ®..."
è§£å†³: 
  1. æ£€æŸ¥è¯é¢˜åç§°: ros2 topic list
  2. æ£€æŸ¥è¯é¢˜é¢‘ç‡: ros2 topic hz /camera1/points

é—®é¢˜2: "ICPæœªæ”¶æ•›"
è§£å†³:
  1. æ£€æŸ¥ç‚¹äº‘é‡å ï¼ˆåœ¨RVizä¸­å¯è§†åŒ–ï¼‰
  2. å¢å¤§ max_correspondence_distance (0.5 -> 1.0)
  3. å¢åŠ  max_iterations (50 -> 100)

é—®é¢˜3: "é€‚é…åº¦åˆ†æ•°å¾ˆå¤§"
è§£å†³:
  1. å¯ç”¨é¢„å¤„ç†: use_voxel_filter: true
  2. å¯ç”¨ç¦»ç¾¤ç‚¹å»é™¤: use_outlier_removal: true
  3. è°ƒæ•´ä½“ç´ å¤§å°: voxel_leaf_size: 0.05

é—®é¢˜4: "å¤„ç†é€Ÿåº¦æ…¢"
è§£å†³:
  1. å¢å¤§ä½“ç´ : voxel_leaf_size: 0.1
  2. å‡å°‘è¿­ä»£: max_iterations: 30

================================================================================
ğŸ“š è¯¦ç»†æ–‡æ¡£
================================================================================

å¿«é€Ÿå¼€å§‹:  ICP_QUICKSTART.md           (5åˆ†é’Ÿä¸Šæ‰‹)
å®Œæ•´æ‰‹å†Œ:  ICP_CALIBRATION_README.md   (è¯¦ç»†å‚æ•°è¯´æ˜)
å®ŒæˆæŠ¥å‘Š:  ICP_èŠ‚ç‚¹æ·»åŠ æŠ¥å‘Š.md         (åŠŸèƒ½æ€»è§ˆ)

================================================================================
âœ… éªŒè¯æ¸…å•
================================================================================

å¯åŠ¨å‰æ£€æŸ¥:
  â–¡ æ˜¯å¦å·²ç¼–è¯‘: colcon build --packages-select obstacle_avoidance
  â–¡ æ˜¯å¦source: source install/setup.bash
  â–¡ é…ç½®æ˜¯å¦æ­£ç¡®: è¯é¢˜åç§°æ˜¯å¦åŒ¹é…å®é™…

å¯åŠ¨åæ£€æŸ¥:
  â–¡ èŠ‚ç‚¹æ˜¯å¦è¿è¡Œ: ros2 node list | grep icp
  â–¡ è¯é¢˜æ˜¯å¦æ­£å¸¸: ros2 topic list | grep icp_transform
  â–¡ æ•°æ®æ˜¯å¦å‘å¸ƒ: ros2 topic hz /icp_transform

ç»“æœéªŒè¯:
  â–¡ converged æ˜¯å¦ä¸º true
  â–¡ fitness_score æ˜¯å¦ < 0.1
  â–¡ å¹³ç§»/æ—‹è½¬æ˜¯å¦åˆç†

================================================================================
ğŸ¯ å…¸å‹ä½¿ç”¨åœºæ™¯
================================================================================

åœºæ™¯1: æ ‡å®šä¸¤ä¸ªæ·±åº¦ç›¸æœº
  topic1: "/camera_dog/depth/points"
  topic2: "/camera_person/depth/points"
  
åœºæ™¯2: æ ‡å®šæ¿€å…‰é›·è¾¾å’Œç›¸æœº
  topic1: "/lidar/points"
  topic2: "/camera/depth/points"
  
åœºæ™¯3: ä¸video_clienté›†æˆ
  topic1: "/camera1/points"
  topic2: "/camera_person"  (video_clientå‘å¸ƒçš„ç‚¹äº‘)

================================================================================
ğŸ“ å¿«é€Ÿå¸®åŠ©
================================================================================

æŸ¥çœ‹å‚æ•°åˆ—è¡¨:
  ros2 param list /icp_calibration_node

æŸ¥çœ‹æŸä¸ªå‚æ•°å€¼:
  ros2 param get /icp_calibration_node topic1

åŠ¨æ€ä¿®æ”¹å‚æ•°:
  ros2 param set /icp_calibration_node calibration_interval 10.0

æŸ¥çœ‹æ—¥å¿—ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰:
  ros2 run obstacle_avoidance icp_calibration_node --ros-args \
    --log-level DEBUG

================================================================================
ğŸ‰ å¸¸ç”¨å‘½ä»¤ç»„åˆ
================================================================================

å®Œæ•´æµ‹è¯•æµç¨‹:
--------------
# ç»ˆç«¯1: å¯åŠ¨èŠ‚ç‚¹
ros2 launch obstacle_avoidance icp_calibration.launch.py

# ç»ˆç«¯2: ç›‘å¬ç»“æœ
python3 src/obstacle_avoidance/scripts/icp_transform_listener.py

# ç»ˆç«¯3: æ£€æŸ¥çŠ¶æ€
ros2 node info /icp_calibration_node
ros2 topic hz /icp_transform

éªŒè¯ç‚¹äº‘è¯é¢˜:
-------------
ros2 topic list | grep points
ros2 topic hz /camera1/points
ros2 topic hz /camera2/points
ros2 topic echo /camera1/points --once

æŸ¥çœ‹èŠ‚ç‚¹æ€§èƒ½:
-------------
ros2 topic bw /icp_transform    # å¸¦å®½
ros2 topic hz /icp_transform    # é¢‘ç‡
ros2 topic info /icp_transform  # è¯¦ç»†ä¿¡æ¯

================================================================================

èŠ‚ç‚¹çŠ¶æ€: âœ… å·²ç¼–è¯‘é€šè¿‡
æµ‹è¯•çŠ¶æ€: â³ å¾…æµ‹è¯•
ROSç‰ˆæœ¬:  ROS2 Humble

è¯¦ç»†æ–‡æ¡£è¯·æŸ¥çœ‹ ICP_QUICKSTART.md æˆ– ICP_CALIBRATION_README.md

================================================================================

